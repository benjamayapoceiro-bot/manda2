<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manda2 Delivery - Iniciar Sesión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hero-title { font-family: 'Playfair Display', serif; }
        .gradient-text { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); 
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent; 
        }
        .form-input { transition: all 0.3s ease; }
        .form-input:focus { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .auth-container { min-height: 100vh; }
        .auth-card { backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-white">
    <div class="auth-container flex items-center justify-center px-4 py-8">
        <div class="auth-card bg-white/90 max-w-md w-full rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="hero-title text-4xl font-bold gradient-text mb-2">Manda2</h1>
                <p class="text-gray-600">El marketplace hiperlocal de 9 de Julio</p>
            </div>

            <div id="login-form">
                <h2 id="form-title" class="text-2xl font-bold text-gray-900 mb-6 text-center">Iniciar Sesión</h2>
                
                <form id="auth-form" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" name="email" required 
                               class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                               placeholder="tu@email.com">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                        <input type="password" id="password" name="password" required 
                               class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                               placeholder="••••••••">
                    </div>
                    
                    <div>
                        <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuario</label>
                        <select id="role" name="role" required 
                                class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="">Selecciona tu rol</option>
                            <option value="customer">Cliente</option>
                            <option value="business">Comercio</option>
                            <option value="driver">Repartidor</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    
                    <div id="form-message" class="text-center text-sm mt-2"></div>
                    
                    <button type="submit" 
                            class="w-full bg-orange-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-orange-700 transition-all duration-300 transform hover:scale-105 focus:ring-4 focus:ring-orange-200">
                        <span id="submit-btn-text">Iniciar Sesión</span>
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-gray-600 text-sm">
                        <span id="toggle-text">¿No tienes cuenta?</span>
                        <button id="toggle-auth-mode" class="text-orange-600 hover:text-orange-700 font-semibold">
                            Regístrate aquí
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Integración Supabase Auth con modo registro/login
        const SUPABASE_URL = 'https://nluelbugvzzogdzecbhz.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_3wsMNK5q9B8hR0679I7zBQ_qWoNEVQ9';
        let isRegisterMode = false;
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js';
        document.head.appendChild(script);
        
        script.onload = function() {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Toggle entre login y registro
            document.getElementById('toggle-auth-mode').addEventListener('click', function() {
                isRegisterMode = !isRegisterMode;
                document.getElementById('form-title').textContent = isRegisterMode ? 'Registrarse' : 'Iniciar Sesión';
                document.getElementById('submit-btn-text').textContent = isRegisterMode ? 'Registrarse' : 'Iniciar Sesión';
                document.getElementById('toggle-text').textContent = isRegisterMode ? '¿Ya tienes cuenta?' : '¿No tienes cuenta?';
                document.getElementById('toggle-auth-mode').textContent = isRegisterMode ? 'Iniciar Sesión aquí' : 'Regístrate aquí';
                document.getElementById('form-message').textContent = '';
            });
            
            // Manejo del formulario
            document.getElementById('auth-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('role').value;
                const button = e.target.querySelector('button[type="submit"]');
                const messageDiv = document.getElementById('form-message');
                
                button.disabled = true;
                messageDiv.textContent = '';
                
                if (isRegisterMode) {
                    // Registro
                    let { data, error } = await supabase.auth.signUp({ email, password });
                    if (error) {
                        messageDiv.textContent = 'Error: ' + error.message;
                        messageDiv.className = 'text-center text-sm mt-2 text-red-600';
                        button.disabled = false;
                        return;
                    }
                    
                    messageDiv.textContent = 'Registro exitoso. Revisa tu correo para confirmar la cuenta.';
                    messageDiv.className = 'text-center text-sm mt-2 text-green-600';
                    
                    // Guardar datos en localStorage
                    const userData = {
                        email: email,
                        role: role,
                        name: email.split('@')[0],
                        id: data.user ? data.user.id : null
                    };
                    localStorage.setItem('manda2_user', JSON.stringify(userData));
                    button.disabled = false;
                } else {
                    // Login
                    let { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) {
                        messageDiv.textContent = 'Error: ' + error.message;
                        messageDiv.className = 'text-center text-sm mt-2 text-red-600';
                        button.disabled = false;
                        return;
                    }
                    
                    // Guardar datos en localStorage
                    const userData = {
                        email: email,
                        role: role,
                        name: email.split('@')[0],
                        id: data.user ? data.user.id : null
                    };
                    localStorage.setItem('manda2_user', JSON.stringify(userData));
                    
                    // Redirigir según rol
                    switch(role) {
                        case 'customer':
                            window.location.href = 'customer.html';
                            break;
                        case 'business':
                            window.location.href = 'business.html';
                            break;
                        case 'driver':
                            window.location.href = 'driver.html';
                            break;
                        case 'admin':
                            window.location.href = 'admin.html';
                            break;
                        default:
                            window.location.href = 'index.html';
                    }
                }
            });
            
            // Verificar si el usuario ya está logueado
            window.addEventListener('load', async function() {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    const userData = JSON.parse(localStorage.getItem('manda2_user')) || {};
                    switch(userData.role) {
                        case 'customer':
                            window.location.href = 'customer.html';
                            break;
                        case 'business':
                            window.location.href = 'business.html';
                            break;
                        case 'driver':
                            window.location.href = 'driver.html';
                            break;
                        case 'admin':
                            window.location.href = 'admin.html';
                            break;
                    }
                }
            });
        };
    </script>
</body>
</html>